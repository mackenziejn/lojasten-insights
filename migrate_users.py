# migrate_users.py
import sqlite3
import psycopg2
import json
import os
import sys
from datetime import datetime

# Configura√ß√µes
SQLITE_DB = "data/db/vendas.db"
SUPABASE_CONFIG = {
    "host": "db.azczqeoyncpgqtxgdazp.supabase.co",
    "database": "postgres", 
    "user": "postgres",
    "password": os.getenv('SUPABASE_DB_PASSWORD', 'Laurinha250520'),  # ‚ö†Ô∏è ATUALIZE A SENHA!
    "port": "5432"
}

# Configurar logging
import logging
logging.basicConfig(
    level=logging.INFO,
    format='%(asctime)s - %(levelname)s - %(message)s',
    datefmt='%Y-%m-%d %H:%M:%S'
)
logger = logging.getLogger(__name__)

def testar_conexao_supabase():
    """Testa a conex√£o com o Supabase"""
    try:
        conn = psycopg2.connect(**SUPABASE_CONFIG)
        cursor = conn.cursor()
        cursor.execute("SELECT version();")
        version = cursor.fetchone()[0]
        conn.close()
        logger.info(f"‚úÖ Conex√£o com Supabase bem-sucedida")
        return True, "Conex√£o estabelecida"
    except Exception as e:
        logger.error(f"‚ùå Erro na conex√£o com Supabase: {e}")
        return False, str(e)

def criar_tabela_usuarios_supabase():
    """Cria a tabela usuarios no Supabase se n√£o existir"""
    try:
        conn = psycopg2.connect(**SUPABASE_CONFIG)
        cursor = conn.cursor()
        
        # Verificar se tabela j√° existe
        cursor.execute("""
            SELECT table_name 
            FROM information_schema.tables 
            WHERE table_schema = 'public' AND table_name = 'usuarios'
        """)
        
        if cursor.fetchone():
            logger.info("‚úÖ Tabela 'usuarios' j√° existe no Supabase")
            conn.close()
            return True
        
        # Criar tabela usuarios no PostgreSQL
        cursor.execute("""
            CREATE TABLE usuarios (
                id SERIAL PRIMARY KEY,
                login VARCHAR(50) UNIQUE NOT NULL,
                password VARCHAR(255) NOT NULL,
                role VARCHAR(20) NOT NULL DEFAULT 'user',
                nome VARCHAR(100) NOT NULL,
                loja VARCHAR(100) NOT NULL,
                codigo_vendedor VARCHAR(50),
                permissions JSONB DEFAULT '{}',
                ativo BOOLEAN DEFAULT true,
                created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
                ultimo_login TIMESTAMP WITH TIME ZONE,
                data_atualizacao TIMESTAMP WITH TIME ZONE DEFAULT NOW()
            )
        """)
        
        conn.commit()
        conn.close()
        logger.info("‚úÖ Tabela 'usuarios' criada no Supabase")
        return True
        
    except Exception as e:
        logger.error(f"‚ùå Erro ao criar tabela usuarios: {e}")
        return False

def carregar_usuarios_json():
    """Carrega usu√°rios do arquivo JSON"""
    try:
        json_path = "users.json"
        if not os.path.exists(json_path):
            logger.error(f"‚ùå Arquivo {json_path} n√£o encontrado")
            return {}
            
        with open(json_path, 'r', encoding='utf-8') as f:
            usuarios = json.load(f)
        
        logger.info(f"‚úÖ {len(usuarios)} usu√°rios carregados do JSON")
        return usuarios
        
    except Exception as e:
        logger.error(f"‚ùå Erro ao carregar JSON: {e}")
        return {}

def carregar_usuarios_sqlite():
    """Carrega usu√°rios do SQLite local"""
    try:
        if not os.path.exists(SQLITE_DB):
            logger.error(f"‚ùå Banco SQLite n√£o encontrado: {SQLITE_DB}")
            return []
            
        conn = sqlite3.connect(SQLITE_DB)
        cursor = conn.cursor()
        
        # Verificar se tabela existe
        cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='usuarios'")
        if not cursor.fetchone():
            logger.error("‚ùå Tabela 'usuarios' n√£o encontrada no SQLite")
            conn.close()
            return []
        
        # Buscar usu√°rios
        cursor.execute("""
            SELECT login, password, role, nome, loja, codigo_vendedor, permissions, ativo 
            FROM usuarios
        """)
        usuarios = cursor.fetchall()
        conn.close()
        
        logger.info(f"‚úÖ {len(usuarios)} usu√°rios carregados do SQLite")
        return usuarios
        
    except Exception as e:
        logger.error(f"‚ùå Erro ao carregar usu√°rios do SQLite: {e}")
        return []

def migrar_usuarios_sqlite_para_supabase():
    """Migra usu√°rios do SQLite para o Supabase"""
    try:
        usuarios_sqlite = carregar_usuarios_sqlite()
        if not usuarios_sqlite:
            logger.warning("‚ö†Ô∏è Nenhum usu√°rio encontrado no SQLite")
            return False
            
        conn = psycopg2.connect(**SUPABASE_CONFIG)
        cursor = conn.cursor()
        
        usuarios_migrados = 0
        erros = 0
        
        for usuario in usuarios_sqlite:
            try:
                if len(usuario) == 8:
                    login, password, role, nome, loja, codigo_vendedor, permissions_str, ativo = usuario
                else:
                    logger.warning(f"‚ö†Ô∏è Estrutura inv√°lida do usu√°rio: {usuario}")
                    continue
                
                # Tratar valores None
                codigo_vendedor = codigo_vendedor or ""
                ativo = bool(ativo) if ativo is not None else True
                role = role or "user"
                
                # Converter permissions
                try:
                    if permissions_str and isinstance(permissions_str, str):
                        permissions = json.loads(permissions_str)
                    else:
                        permissions = permissions_str or {}
                except:
                    permissions = {
                        "ver_filtros": True,
                        "ver_indicadores": True,
                        "ver_graficos": True,
                        "executar_pipeline": False,
                        "analisar_todas_lojas": False,
                        "upload_csv": False
                    }
                
                # Inserir no Supabase
                cursor.execute("""
                    INSERT INTO usuarios (login, password, role, nome, loja, codigo_vendedor, permissions, ativo)
                    VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
                    ON CONFLICT (login) DO UPDATE SET
                        password = EXCLUDED.password,
                        role = EXCLUDED.role,
                        nome = EXCLUDED.nome,
                        loja = EXCLUDED.loja,
                        codigo_vendedor = EXCLUDED.codigo_vendedor,
                        permissions = EXCLUDED.permissions,
                        ativo = EXCLUDED.ativo,
                        data_atualizacao = NOW()
                """, (login, password, role, nome, loja, codigo_vendedor, json.dumps(permissions), ativo))
                
                usuarios_migrados += 1
                logger.info(f"‚úÖ Usu√°rio migrado: {login} ({nome})")
                
            except Exception as user_error:
                erros += 1
                logger.error(f"‚ùå Erro ao migrar usu√°rio {usuario[0]}: {user_error}")
                continue
        
        conn.commit()
        conn.close()
        
        logger.info(f"üéâ Migra√ß√£o SQLite‚ÜíSupabase conclu√≠da!")
        logger.info(f"üìä Usu√°rios migrados: {usuarios_migrados}")
        logger.info(f"‚ùå Erros: {erros}")
        
        return usuarios_migrados > 0
        
    except Exception as e:
        logger.error(f"‚ùå Erro na migra√ß√£o SQLite‚ÜíSupabase: {e}")
        return False

def migrar_usuarios_json_para_supabase():
    """Migra usu√°rios diretamente do JSON para o Supabase"""
    try:
        usuarios_json = carregar_usuarios_json()
        if not usuarios_json:
            logger.error("‚ùå Nenhum usu√°rio encontrado no JSON para migrar")
            return False
            
        conn = psycopg2.connect(**SUPABASE_CONFIG)
        cursor = conn.cursor()
        
        usuarios_migrados = 0
        erros = 0
        
        for login, dados in usuarios_json.items():
            try:
                password = dados.get('password', '')
                role = dados.get('role', 'user')
                nome = dados.get('nome', '')
                loja = dados.get('loja', '')
                codigo_vendedor = dados.get('codigo_vendedor', '')
                permissions = dados.get('permissions', {})
                ativo = dados.get('ativo', True)
                email = dados.get('email', '')
                
                # Inserir no Supabase
                cursor.execute("""
                    INSERT INTO usuarios (login, password, role, nome, loja, codigo_vendedor, permissions, ativo)
                    VALUES (%s, %s, %s, %s, %s, %s, %s, %s)
                    ON CONFLICT (login) DO UPDATE SET
                        password = EXCLUDED.password,
                        role = EXCLUDED.role,
                        nome = EXCLUDED.nome,
                        loja = EXCLUDED.loja,
                        codigo_vendedor = EXCLUDED.codigo_vendedor,
                        permissions = EXCLUDED.permissions,
                        ativo = EXCLUDED.ativo,
                        data_atualizacao = NOW()
                """, (login, password, role, nome, loja, codigo_vendedor, json.dumps(permissions), ativo))
                
                usuarios_migrados += 1
                logger.info(f"‚úÖ Usu√°rio migrado do JSON: {login} ({nome})")
                
            except Exception as user_error:
                erros += 1
                logger.error(f"‚ùå Erro ao migrar usu√°rio {login}: {user_error}")
                continue
        
        conn.commit()
        conn.close()
        
        logger.info(f"üéâ Migra√ß√£o JSON‚ÜíSupabase conclu√≠da!")
        logger.info(f"üìä Usu√°rios migrados: {usuarios_migrados}")
        logger.info(f"‚ùå Erros: {erros}")
        
        return usuarios_migrados > 0
        
    except Exception as e:
        logger.error(f"‚ùå Erro na migra√ß√£o JSON‚ÜíSupabase: {e}")
        return False

def migrar_usuarios_para_sqlite():
    """Migra usu√°rios do JSON para o SQLite (fallback)"""
    try:
        usuarios_json = carregar_usuarios_json()
        if not usuarios_json:
            logger.error("‚ùå Nenhum usu√°rio encontrado no JSON")
            return False
            
        # Garantir que o diret√≥rio existe
        os.makedirs(os.path.dirname(SQLITE_DB), exist_ok=True)
        
        conn = sqlite3.connect(SQLITE_DB)
        cursor = conn.cursor()
        
        # Criar tabela se n√£o existir
        cursor.execute("""
            CREATE TABLE IF NOT EXISTS usuarios (
                login TEXT PRIMARY KEY,
                password TEXT NOT NULL,
                role TEXT NOT NULL,
                nome TEXT NOT NULL,
                loja TEXT NOT NULL,
                codigo_vendedor TEXT,
                permissions TEXT NOT NULL,
                ativo BOOLEAN DEFAULT 1
            )
        """)
        
        usuarios_migrados = 0
        erros = 0
        
        for login, dados in usuarios_json.items():
            try:
                password = dados.get('password', '')
                role = dados.get('role', 'user')
                nome = dados.get('nome', '')
                loja = dados.get('loja', '')
                codigo_vendedor = dados.get('codigo_vendedor', '')
                permissions = json.dumps(dados.get('permissions', {}))
                ativo = 1 if dados.get('ativo', True) else 0
                
                cursor.execute("""
                    INSERT OR REPLACE INTO usuarios 
                    (login, password, role, nome, loja, codigo_vendedor, permissions, ativo)
                    VALUES (?, ?, ?, ?, ?, ?, ?, ?)
                """, (login, password, role, nome, loja, codigo_vendedor, permissions, ativo))
                
                usuarios_migrados += 1
                logger.info(f"‚úÖ Usu√°rio migrado para SQLite: {login} ({nome})")
                
            except Exception as user_error:
                erros += 1
                logger.error(f"‚ùå Erro ao migrar usu√°rio {login} para SQLite: {user_error}")
                continue
        
        conn.commit()
        conn.close()
        
        logger.info(f"üéâ Migra√ß√£o para SQLite conclu√≠da!")
        logger.info(f"üìä Usu√°rios migrados: {usuarios_migrados}")
        logger.info(f"‚ùå Erros: {erros}")
        
        return usuarios_migrados > 0
        
    except Exception as e:
        logger.error(f"‚ùå Erro na migra√ß√£o para SQLite: {e}")
        return False

def verificar_usuarios_supabase():
    """Verifica os usu√°rios no Supabase"""
    try:
        conn = psycopg2.connect(**SUPABASE_CONFIG)
        cursor = conn.cursor()
        
        # Contar usu√°rios
        cursor.execute("SELECT COUNT(*) as total FROM usuarios")
        total = cursor.fetchone()[0]
        
        # Listar usu√°rios
        cursor.execute("""
            SELECT login, nome, role, loja, ativo, created_at 
            FROM usuarios 
            ORDER BY login
        """)
        usuarios = cursor.fetchall()
        
        logger.info(f"\nüë• USU√ÅRIOS NO SUPABASE (Total: {total}):")
        logger.info("-" * 80)
        
        for usuario in usuarios:
            login, nome, role, loja, ativo, created_at = usuario
            status = "‚úÖ ATIVO" if ativo else "‚ùå INATIVO"
            logger.info(f"   üë§ {login:<15} | {nome:<20} | {role:<10} | {loja:<15} | {status}")
        
        conn.close()
        return total
        
    except Exception as e:
        logger.error(f"‚ùå Erro ao verificar usu√°rios no Supabase: {e}")
        return 0

def verificar_usuarios_sqlite():
    """Verifica os usu√°rios no SQLite"""
    try:
        if not os.path.exists(SQLITE_DB):
            logger.error(f"‚ùå Banco SQLite n√£o encontrado: {SQLITE_DB}")
            return 0
            
        conn = sqlite3.connect(SQLITE_DB)
        cursor = conn.cursor()
        
        # Verificar se tabela existe
        cursor.execute("SELECT name FROM sqlite_master WHERE type='table' AND name='usuarios'")
        if not cursor.fetchone():
            logger.error("‚ùå Tabela 'usuarios' n√£o encontrada no SQLite")
            conn.close()
            return 0
        
        # Contar usu√°rios
        cursor.execute("SELECT COUNT(*) as total FROM usuarios")
        total = cursor.fetchone()[0]
        
        # Listar usu√°rios
        cursor.execute("SELECT login, nome, role, loja, ativo FROM usuarios ORDER BY login")
        usuarios = cursor.fetchall()
        
        logger.info(f"\nüë• USU√ÅRIOS NO SQLITE (Total: {total}):")
        logger.info("-" * 80)
        
        for usuario in usuarios:
            login, nome, role, loja, ativo = usuario
            status = "‚úÖ ATIVO" if ativo else "‚ùå INATIVO"
            logger.info(f"   üë§ {login:<15} | {nome:<20} | {role:<10} | {loja:<15} | {status}")
        
        conn.close()
        return total
        
    except Exception as e:
        logger.error(f"‚ùå Erro ao verificar usu√°rios no SQLite: {e}")
        return 0

def testar_autenticacao():
    """Testa a autentica√ß√£o de usu√°rios"""
    try:
        conn = psycopg2.connect(**SUPABASE_CONFIG)
        cursor = conn.cursor()
        
        logger.info("\nüîê TESTE DE AUTENTICA√á√ÉO:")
        logger.info("-" * 50)
        
        # Testar com admin
        cursor.execute("SELECT login, password, nome, role, ativo FROM usuarios WHERE login = 'admin'")
        admin = cursor.fetchone()
        
        if admin:
            login, password, nome, role, ativo = admin
            logger.info(f"   ‚úÖ ADMIN: {login} | {nome} | {role} | {'‚úÖ ATIVO' if ativo else '‚ùå INATIVO'}")
            logger.info(f"   üîë Senha: {password}")
        else:
            logger.error("   ‚ùå Usu√°rio admin n√£o encontrado")
        
        # Testar com csilva
        cursor.execute("SELECT login, password, nome, role, ativo FROM usuarios WHERE login = 'csilva'")
        csilva = cursor.fetchone()
        
        if csilva:
            login, password, nome, role, ativo = csilva
            logger.info(f"   ‚úÖ CSILVA: {login} | {nome} | {role} | {'‚úÖ ATIVO' if ativo else '‚ùå INATIVO'}")
        else:
            logger.error("   ‚ùå Usu√°rio csilva n√£o encontrado")
        
        conn.close()
        return admin is not None
        
    except Exception as e:
        logger.error(f"‚ùå Erro ao testar autentica√ß√£o: {e}")
        return False

def limpar_usuarios_supabase():
    """Limpa todos os usu√°rios do Supabase (CUIDADO!)"""
    try:
        conn = psycopg2.connect(**SUPABASE_CONFIG)
        cursor = conn.cursor()
        
        cursor.execute("DELETE FROM usuarios")
        conn.commit()
        conn.close()
        
        logger.info("‚úÖ Todos os usu√°rios removidos do Supabase")
        return True
        
    except Exception as e:
        logger.error(f"‚ùå Erro ao limpar usu√°rios: {e}")
        return False

def mostrar_estatisticas():
    """Mostra estat√≠sticas dos bancos"""
    logger.info("\nüìä ESTAT√çSTICAS DOS BANCOS:")
    logger.info("=" * 50)
    
    # Supabase
    total_supabase = verificar_usuarios_supabase()
    
    # SQLite
    total_sqlite = verificar_usuarios_sqlite()
    
    logger.info(f"\nüìà RESUMO:")
    logger.info(f"   ‚úÖ Supabase: {total_supabase} usu√°rios")
    logger.info(f"   ‚úÖ SQLite: {total_sqlite} usu√°rios")
    
    return total_supabase, total_sqlite

def main():
    """Fun√ß√£o principal"""
    if len(sys.argv) > 1:
        comando = sys.argv[1].lower()
        
        if comando == "verificar":
            mostrar_estatisticas()
            
        elif comando == "testar":
            testar_autenticacao()
            
        elif comando == "sqlite":
            logger.info("üîÑ Migrando do SQLite para Supabase...")
            criar_tabela_usuarios_supabase()
            migrar_usuarios_sqlite_para_supabase()
            verificar_usuarios_supabase()
            
        elif comando == "json":
            logger.info("üîÑ Migrando do JSON para Supabase...")
            criar_tabela_usuarios_supabase()
            migrar_usuarios_json_para_supabase()
            verificar_usuarios_supabase()
            
        elif comando == "sqlite-only":
            logger.info("üîÑ Migrando para SQLite...")
            migrar_usuarios_para_sqlite()
            verificar_usuarios_sqlite()
            
        elif comando == "ambos":
            logger.info("üîÑ Migrando para ambos os bancos...")
            migrar_usuarios_para_sqlite()
            criar_tabela_usuarios_supabase()
            migrar_usuarios_json_para_supabase()
            mostrar_estatisticas()
            
        elif comando == "limpar":
            logger.warning("‚ö†Ô∏è  LIMPANDO TODOS OS USU√ÅRIOS DO SUPABASE!")
            confirmacao = input("‚ùì Tem certeza? (digite 'SIM' para confirmar): ")
            if confirmacao.upper() == "SIM":
                limpar_usuarios_supabase()
            else:
                logger.info("‚ùå Opera√ß√£o cancelada")
                
        elif comando == "ajuda" or comando == "help":
            mostrar_ajuda()
            
        else:
            logger.error("‚ùå Comando inv√°lido")
            mostrar_ajuda()
    else:
        # Comando padr√£o: migra√ß√£o inteligente
        logger.info("üöÄ INICIANDO MIGRA√á√ÉO INTELIGENTE...")
        
        # Testar conex√£o com Supabase
        sucesso, mensagem = testar_conexao_supabase()
        if not sucesso:
            logger.error("‚ùå N√£o foi poss√≠vel conectar ao Supabase")
            logger.info("üì¶ Migrando apenas para SQLite...")
            migrar_usuarios_para_sqlite()
            verificar_usuarios_sqlite()
            return
        
        # Criar tabela no Supabase
        criar_tabela_usuarios_supabase()
        
        # Tentar migrar do SQLite primeiro
        if not migrar_usuarios_sqlite_para_supabase():
            logger.info("üîÑ Fallback: migrando do JSON...")
            migrar_usuarios_json_para_supabase()
        
        # Tamb√©m garantir SQLite local
        migrar_usuarios_para_sqlite()
        
        # Mostrar estat√≠sticas finais
        mostrar_estatisticas()
        testar_autenticacao()

def mostrar_ajuda():
    """Mostra ajuda dos comandos"""
    logger.info("\nüéØ COMANDOS DISPON√çVEIS:")
    logger.info("=" * 50)
    logger.info("   python migrate_users.py           # Migra√ß√£o inteligente (padr√£o)")
    logger.info("   python migrate_users.py verificar # Verificar usu√°rios em ambos")
    logger.info("   python migrate_users.py testar    # Testar autentica√ß√£o")
    logger.info("   python migrate_users.py sqlite    # SQLite ‚Üí Supabase")
    logger.info("   python migrate_users.py json      # JSON ‚Üí Supabase") 
    logger.info("   python migrate_users.py sqlite-only # JSON ‚Üí SQLite")
    logger.info("   python migrate_users.py ambos     # Para ambos bancos")
    logger.info("   python migrate_users.py limpar    # Limpar Supabase (CUIDADO!)")
    logger.info("   python migrate_users.py ajuda     # Mostrar esta ajuda")
    logger.info("\nüí° DICA: Configure a senha do Supabase na vari√°vel SUPABASE_DB_PASSWORD")

if __name__ == "__main__":
    logger.info("=" * 60)
    logger.info("üîÑ MIGRADOR DE USU√ÅRIOS - SQLite ‚Üî Supabase")
    logger.info("=" * 60)
    
    main()
    
    logger.info("\nüéâ Processo conclu√≠do!")